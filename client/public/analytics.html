<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; color:#111; background:#fafafa; }
    h1 { margin-bottom: 8px; }
    section { margin-top: 24px; }
    table { border-collapse: collapse; width: 100%; background:#fff; }
    th, td { border-bottom:1px solid #ddd; padding:4px 6px; text-align:right; }
    th:first-child, td:first-child { text-align:left; }
    .filters { display:flex; gap:8px; align-items:center; margin-bottom:16px; }
    input, button { padding:4px 6px; }
    canvas { background:#fff; border:1px solid #ddd; border-radius:8px; padding:4px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h1>Analytics</h1>
  <div class="filters">
    <label>From <input type="date" id="from"></label>
    <label>To <input type="date" id="to"></label>
    <button id="reload">Reload</button>
  </div>

  <section>
    <h2>Backtest equity</h2>
    <canvas id="backtestChart" height="160"></canvas>
  </section>

  <section>
    <h2>Optimize top 20</h2>
    <div style="overflow:auto;">
      <table id="optTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="optEmpty" class="muted"></div>
  </section>

  <section>
    <h2>Walkforward</h2>
    <div style="overflow:auto;">
      <table id="walkTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="walkEmpty" class="muted"></div>
  </section>

  <section>
    <h2>Live Trade History</h2>
    <canvas id="liveChart" height="160"></canvas>
    <div style="overflow:auto; margin-top:8px;">
      <table id="tradeTable">
        <thead>
          <tr><th>id</th><th>time</th><th>symbol</th><th>entry</th><th>exit</th><th>pnl</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="tradeEmpty" class="muted"></div>
  </section>

  <script>
    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const parts = line.split(',');
        const obj = {};
        headers.forEach((h, i) => {
          const v = parts[i];
          const n = Number(v);
          obj[h] = Number.isFinite(n) ? n : v;
        });
        return obj;
      });
    }

    function renderTable(tbl, rows) {
      const thead = tbl.querySelector('thead');
      const tbody = tbl.querySelector('tbody');
      if (!rows.length) { thead.innerHTML=''; tbody.innerHTML=''; return; }
      const headers = Object.keys(rows[0]);
      thead.innerHTML = '<tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr>';
      tbody.innerHTML = rows.map(r => '<tr>' + headers.map(h=>`<td>${r[h]}</td>`).join('') + '</tr>').join('');
    }

    let btChart = new Chart(document.getElementById('backtestChart'), {
      type:'line', data:{labels:[], datasets:[{label:'Equity', data:[], tension:0.2, pointRadius:0}]},
      options:{responsive:true, scales:{x:{ticks:{maxTicksLimit:6}}}}
    });
    let liveChart = new Chart(document.getElementById('liveChart'), {
      type:'line', data:{labels:[], datasets:[{label:'Equity', data:[], tension:0.2, pointRadius:0}]},
      options:{responsive:true, scales:{x:{ticks:{maxTicksLimit:6}}}}
    });

    async function loadBacktest() {
      try {
        const res = await fetch('/analytics/backtest.csv');
        if (!res.ok) throw new Error('no');
        const rows = parseCsv(await res.text());
        if (!rows.length) return;
        const labels = rows.map(r => new Date(r.ts).toLocaleString());
        const data = rows.map(r => r.equity);
        btChart.data.labels = labels;
        btChart.data.datasets[0].data = data;
        btChart.update();
      } catch {
        document.getElementById('backtestChart').insertAdjacentHTML('afterend', '<div class="muted">No data</div>');
      }
    }

    async function loadOptimize() {
      try {
        const res = await fetch('/analytics/optimize.csv');
        if (!res.ok) throw new Error('no');
        const rows = parseCsv(await res.text()).slice(0,20);
        if (!rows.length) { document.getElementById('optEmpty').textContent = 'No data'; return; }
        renderTable(document.getElementById('optTable'), rows);
      } catch {
        document.getElementById('optEmpty').textContent = 'No data';
      }
    }

    async function loadWalkforward() {
      try {
        const res = await fetch('/analytics/walkforward.csv');
        if (!res.ok) throw new Error('no');
        const rows = parseCsv(await res.text());
        if (!rows.length) { document.getElementById('walkEmpty').textContent = 'No data'; return; }
        renderTable(document.getElementById('walkTable'), rows);
      } catch {
        document.getElementById('walkEmpty').textContent = 'No data';
      }
    }

    async function loadTrades() {
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      const params = new URLSearchParams();
      if (from) params.set('from', from);
      if (to) params.set('to', to);
      try {
        const res = await fetch('/analytics/data?' + params.toString());
        const data = await res.json();
        const eq = data.equity || [];
        if (!eq.length) {
          liveChart.data.labels = []; liveChart.data.datasets[0].data = []; liveChart.update();
          document.getElementById('tradeEmpty').textContent = 'No closed trades';
        } else {
          liveChart.data.labels = eq.map(p => new Date(p.ts).toLocaleString());
          liveChart.data.datasets[0].data = eq.map(p => p.equity);
          liveChart.update();
          document.getElementById('tradeEmpty').textContent = '';
        }
        const tblRows = (data.trades || []).map(t => ({
          id: t.id,
          time: new Date(t.closed_at).toLocaleString(),
          symbol: t.symbol,
          entry: t.entry_price,
          exit: t.exit_price,
          pnl: t.pnl
        }));
        renderTable(document.getElementById('tradeTable'), tblRows);
        if (!tblRows.length) document.getElementById('tradeEmpty').textContent = 'No closed trades';
      } catch {
        document.getElementById('tradeEmpty').textContent = 'No closed trades';
      }
    }

    document.getElementById('reload').addEventListener('click', loadTrades);

    loadBacktest();
    loadOptimize();
    loadWalkforward();
    loadTrades();
  </script>
</body>
</html>

