groups:
- name: api.rules
  rules:
  - alert: HighErrorRate
    expr: sum(rate(http_requests_total{status=~"5.."}[5m])) \
          / sum(rate(http_requests_total[5m])) > 0.05
    for: 10m
    labels: { severity: page }
    annotations:
      summary: "API 5xx >5% (10m)"
  - alert: SlowRequests
    expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
    for: 10m
    labels: { severity: ticket }
    annotations:
      summary: "p95 > 1s (10m)"

- name: sse.rules
  rules:
  - alert: NoSSEClients
    expr: sse_connections == 0
    for: 15m
    labels: { severity: ticket }
    annotations:
      summary: "Nėra aktyvių SSE klientų 15 min"
  - alert: SSENotEmitting
    expr: rate(sse_events_sent_total[10m]) == 0 and sse_connections > 0
    for: 10m
    labels: { severity: page }
    annotations:
      summary: "SSE nepristato event’ų"
      
- name: jobs.rules
  rules:
  - alert: JobsFailing
    expr: rate(job_duration_seconds_count{status="err"}[15m]) > 0
    for: 15m
    labels: { severity: ticket }
    annotations:
      summary: "Job’ai fail’inasi"
  - alert: JobTooSlow
    expr: histogram_quantile(0.95, sum(rate(job_duration_seconds_bucket[15m])) by (le,type)) > 300
    for: 15m
    labels: { severity: ticket }
    annotations:
      summary: "Job {{ $labels.type }} p95 > 5min"
  - alert: JobOverlayEmpty
    expr: increase(job_equity_points_total[30m]) == 0
    for: 30m
    labels: { severity: ticket }
    annotations:
      summary: "Nėra equity points sugeneruotų paskutines 30m"

- name: rum.rules
  rules:
  - alert: RUM_FCP_Degraded
    expr: histogram_quantile(0.9, sum(rate(rum_fcp_seconds_bucket[15m])) by (le)) > 2
    for: 30m
    labels: { severity: ticket }
    annotations:
      summary: "RUM FCP p90 > 2s (30m)"
  - alert: RUM_SSE_Unstable
    expr: increase(rum_sse_reconnect_attempts_total[30m]) > 50
    for: 30m
    labels: { severity: ticket }
    annotations:
      summary: "SSE reconnect bandymai > 50 per 30m"
- name: pipeline.rules
  rules:
  - alert: OTelExporterErrors
    expr: rate(otelcol_exporter_send_failed_spans[5m]) > 0
    for: 10m
    labels: { severity: page }
    annotations:
      summary: "OTel exporter failing (spans)"
  - alert: OTelReceiverRefused
    expr: rate(otelcol_receiver_refused_spans[5m]) > 0
    for: 10m
    labels: { severity: ticket }
    annotations:
      summary: "OTel receiver refused spans (overload?)"
  - alert: LogsExporterErrors
    expr: rate(otelcol_exporter_send_failed_logs[5m]) > 0
    for: 10m
    labels: { severity: ticket }
    annotations:
      summary: "OTel failing to export logs"
