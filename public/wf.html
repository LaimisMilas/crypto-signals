<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Walk-Forward Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .chart { margin: 24px 0; }
    h2 { margin-bottom: 8px; }
    svg { width: 100%; height: 320px; }
    .axis path, .axis line { stroke: #999; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body>
<h1>Walk-Forward Results</h1>

<div class="chart">
  <h2>Fold PnL (bars)</h2>
  <svg id="bars"></svg>
</div>

<div class="chart">
  <h2>Aggregated Equity (line)</h2>
  <svg id="line"></svg>
</div>

<script>
  async function parseCSV(text) {
    const rows = text.trim().split('\n').map(r => r.split(','));
    const header = rows.shift();
    return rows.map(cols => Object.fromEntries(header.map((h,i)=>[h, cols[i]])));
  }

  function drawBars(data) {
    const svg = d3.select('#bars');
    svg.selectAll('*').remove();
    const w = svg.node().clientWidth, h = svg.node().clientHeight;
    const margin = {top:20,right:20,bottom:30,left:50};
    const innerW = w - margin.left - margin.right;
    const innerH = h - margin.top - margin.bottom;

    const x = d3.scaleBand().domain(d3.range(data.length)).range([0, innerW]).padding(0.2);
    const y = d3.scaleLinear().domain([d3.min(data, d=>d.pnl), d3.max(data, d=>d.pnl)]).nice().range([innerH, 0]);

    const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).tickFormat(i=>i+1));
    g.append('g').call(d3.axisLeft(y));

    g.selectAll('rect').data(data).enter().append('rect')
      .attr('x', (_,i) => x(i))
      .attr('y', d => y(Math.max(0,d.pnl)))
      .attr('width', x.bandwidth())
      .attr('height', d => Math.abs(y(d.pnl) - y(0)))
      .attr('fill', d => d.pnl >= 0 ? '#4caf50' : '#f44336')
      .append('title').text(d => `Fold ${d.idx}: PnL ${d.pnl.toFixed(2)}`);
  }

  function drawLine(data) {
    const svg = d3.select('#line');
    svg.selectAll('*').remove();
    const w = svg.node().clientWidth, h = svg.node().clientHeight;
    const margin = {top:20,right:20,bottom:30,left:50};
    const innerW = w - margin.left - margin.right;
    const innerH = h - margin.top - margin.bottom;

    const x = d3.scaleLinear().domain([1, d3.max(data, d=>d.idx)]).range([0, innerW]);
    const y = d3.scaleLinear().domain(d3.extent(data, d=>d.equity)).nice().range([innerH, 0]);

    const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    g.append('g').attr('transform', `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(8));
    g.append('g').call(d3.axisLeft(y));

    const line = d3.line().x(d=>x(d.idx)).y(d=>y(d.equity));
    g.append('path')
      .datum(data)
      .attr('fill','none')
      .attr('stroke','#2196f3')
      .attr('stroke-width',2)
      .attr('d', line);
  }

  async function main() {
    const csv1 = await fetch('/walkforward.csv').then(r=>r.text());
    const rows1 = await parseCSV(csv1);
    const pnlRows = rows1.map((r, i) => ({ idx: i+1, pnl: +r.pnl || 0 }));
    drawBars(pnlRows);

    const csv2 = await fetch('/walkforward-agg.csv').then(r=>r.text());
    const rows2 = await parseCSV(csv2);
    const lineRows = rows2.map(r => ({ idx: +r.idx, equity: +r.equity }));
    drawLine(lineRows);
  }
  main();
</script>
</body>
</html>
